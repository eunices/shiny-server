---
runtime: shiny
title: "COVID-19 in Singapore"
output: 
  html_document:
    toc: true
    theme: flatly
---

> **DISCLAIMER: Not an epidemiologist, so the information below should not be used for policy. Neither has this document gone through peer review, so please do not cite it.**


```{r echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r}
# Libraries
# library(rvest)
library(ggplot2)
library(tidyr)
library(plyr)
library(data.table)
library(gridExtra)
library(ggrepel)
library(ggwordcloud)
library(leaflet)
source('main.r')
source('util.r')

# Params
theme = theme_bw()
```

```{r include=F}
url1 = "https://co.vid19.sg/cases/search"
url2 = "https://www.againstcovid19.com/singapore/cases/search"
# df = try({get_data(url1)})
# if(!grepl("error", df[[1]])) {
#   df = clean_data(df)
# } else {
#   df = get_alternative_data()
# }  

df = get_alternative_data()
df_cases_day = get_df_cases_day()
events = get_events()
lp_clust = get_clusters()
```

```{r}
# Columns are deaths [D], critical condition (ICU) [I1], cases in hospital [I2], 
# cases well but still test positive [I3], recovered [R],
# new cases (imported) [nI], new cases (local) [nL], total cases [total]:
# see cases.csv
```

## What are the figures

### Cases through time

#### New cases through time
```{r}
min_date = min(df$confirmed.at.date, na.rm=T)
max_date = max(df$confirmed.at.date, na.rm=T)
date_second_wave = as.Date("2020-02-25")
```

The first case of covid-19 was detected in Singapore on `r format(min_date, "%d %B %Y")`. 

Key measures and events are marked below. Just at a glance, the border control measures and events (category 4) seem to be effacious as the number of imported cases dropped 31 Mar onwards.

```{r}
style = "display: inline-block;vertical-align:top;padding-right: 20px"
bootstrapPage(
  div(style=style, dateRangeInput("range_date", "Date range", 
                                  start = min_date, end = max_date, 
                                  min = min_date, max = max_date)))


summ = df[,list(N=.N),by=c("confirmed.at.date", "infection.source")]

labels = events[]
labels$xend = labels$date
labels$yend = summ[confirmed.at.date %in% labels$x, list(sum=sum(N)), by="confirmed.at.date"]$sum
labels$x = labels$xend - 5
labels$y = labels$yend + sample(2:6, size=length(labels$yend), replace=T)*50
labels$infection.source = "Local transmission"

cbp1 = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
renderPlot({
  
  min_date = input$range_date[1]
  max_date = input$range_date[2]

  data = df[df$confirmed.at.date >= min_date & df$confirmed.at.date <= max_date,]
  data = data[,list(N=.N),by=c("confirmed.at.date", "infection.source")]
  data = merge(data, labels, by.x=c("confirmed.at.date", "infection.source"), 
               by.y=c("date", "infection.source"), all.x=T, all.y=T)

  plt = ggplot(data=data[confirmed.at.date >= min_date & confirmed.at.date <= max_date], 
               aes(x=confirmed.at.date, y=N, fill=infection.source, label=no)) +
    geom_bar(position='stack', stat="identity") + 
    xlab("") + ylab("Number of cases detected\n") +
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    scale_fill_manual(name="", 
                      labels=c("Event", "Event/measure",
                                "Imported case", "Local transmission", 
                                "Measure", "Unknown"),
                      values=c(cbp1[c(5, 2, 6, 3)], "tomato1", cbp1[1])) + 
    theme +
    theme(legend.position="bottom", legend.box = "horizontal", 
          axis.text.x=element_text(angle = 90)) +
    geom_label_repel(nudge_y=40, angle=90, vjust=0, force=5, 
                     fontface='bold', color='black', size=3, 
                     segment.size=0.5, segment.color='black', 
                     box.padding = unit(0.4, 'lines'), aes(fill=type),
                     arrow = arrow(length = unit(1, "mm")),
                     point.padding = 0, max.iter=3000, show.legend=F)
  
  if(min_date < date_second_wave) {
    plt = plt + geom_vline(xintercept=date_second_wave, size=1, col=cbp1[2], linetype="dotted")
  }
  plt
})
```

```{r}
show_events = events[grepl("event", type)][,c("no", "date", "short")]
show_events$no = paste0("[",show_events$no,"]")
names(show_events) = c("No", "Date", "Event")

show_measures = events[grepl("measure", type)]
show_measures = data.table(unnest(show_measures, related=strsplit(related, ",")))
show_measures$related = as.numeric(show_measures$related)
show_measures$event = paste0("[", show_measures$no, "] ", show_measures$short, " (", 
                             format(show_measures$date, "%d %b"), ")")
show_measures =  show_measures[, list(Measures=paste0(event, collapse = ", ")), by="related"][
  order(as.numeric(related))]
names(show_measures) = c("Category", "Measures")
show_measures[,1] = c(
  "Quarantine and isolation events/measures", 
  "Border control events/measures - to decrease imported cases.",  
  "Social distancing measures - to reduce number of contacts per day.",  
  "Good hygiene measures - to reduce transmission probability of virus.")

show_events %>%
  knitr::kable("html", align = 'clc', caption = 'Events') %>%
    kableExtra::kable_styling(full_width = F, position = "float_left")
 
show_measures %>%
  knitr::kable("html", align = 'clc', caption = 'Measures') %>%
    kableExtra::kable_styling(full_width = F, position = "right")
```


#### Two waves

There were two waves of imported cases, the first from EW 03 to EW 07 and second from EW 08 onwards. These are associated with the Chinese cases mainly and when there was a global spread subsequently with Europe and other countries as the epicenter.

```{r fig.height=12, fig.width=9}
data_1st_wave = df[df$confirmed.at.date < date_second_wave & df$infection.source == "Imported case",]
data_1st_wave = data.table(data_1st_wave)
data_1st_wave = data_1st_wave[, list(N=length(case)), by="country.of.origin"]

data_2nd_wave = df[df$confirmed.at.date >= date_second_wave & df$infection.source == "Imported case",]
data_2nd_wave = data.table(data_2nd_wave)
data_2nd_wave = data_2nd_wave[, list(N=length(case)), by="country.of.origin"]
data_2nd_wave = data_2nd_wave[country.of.origin != "Unclear origin"]

layout = rbind(c(1, 1, 1),
               c(2, 2, 3),
               c(2, 2, 3))

gs = list(ggplot(data_1st_wave, aes(x=reorder(camelcase_labeller("", country.of.origin), -N), y=N)) +
    geom_bar(stat = "identity", fill=cbp1[6]) + coord_flip() + theme_minimal() +
    xlab("") + ylab("") + ggtitle("First wave") +
    theme(axis.text.x=element_text(size=rel(1), angle=90)),

  ggplot(data_2nd_wave, 
        aes(x=reorder(camelcase_labeller("", country.of.origin), -N), y=N, label=N)) +
    geom_bar(stat = "identity", fill=cbp1[3]) + 
    coord_flip() + theme +
    xlab("") + ylab("\nNumber of imported cases detected") + ggtitle("Second wave") +
    theme(axis.text.y=element_text(size=rel(1))) +
    guides(fill=F) +
    geom_text(aes(fill=country.of.origin, y=N+5), colour = "black", 
              fontface = "bold", size=3, show.legend = FALSE, hjust = 0),

  ggplot(data_2nd_wave, aes(label = country.of.origin, size = N, angle=90)) +
    geom_text_wordcloud_area(eccentricity=.35,
                             color=rep_len(cbp1[c(6, 3, 1)], nrow(data_2nd_wave)),
                             shape="pentagon") + theme_minimal() +
    scale_size_area(max_size = 20) 
)

grid.arrange(grobs=gs, layout_matrix=layout)

```

#### Clusters and unlinked cases through time

From 7 Apr onwards, there was a greater number of unlinked cases.

```{r}

renderPlot({
    min_date = input$range_date[1]
    max_date = input$range_date[2]
    data = df[df$confirmed.at.date >= min_date & df$confirmed.at.date <= max_date,]
    data = data[data$infection.source == "Local transmission",]
    data$clustered = ifelse(data$cluster == "", "Not in cluster", "Cluster case")
    cluster = data[data$clustered=="Cluster case",]
    cluster = data[!duplicated(data$cluster),]

    p1 = ggplot(data=cluster, aes(x=confirmed.at.date)) +
      geom_histogram(stat="bin", binwidth=1, fill=cbp1[1]) + 
      xlab("") + ylab("Number of clusters\n") +
      scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
      theme +
      theme(axis.text.x=element_text(angle = 90))

    p2 = ggplot(data=data[data$cluster=="",], aes(x=confirmed.at.date)) +
      geom_histogram(stat="bin", binwidth=1, fill=cbp1[1]) + 
      xlab("") + ylab("Number of local unlinked cases\n") +
      scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
      theme +
      theme(axis.text.x=element_text(angle = 90))

    grid.arrange(p1, p2)
})

```


### Case load

```{r} 
max_load = (9*1200*0.15) + 300 # hospital capacity
hosp_prop = 0.2        # proportion of cases requiring hospitalisation
date_no_hosp = as.Date("2020-03-24") # date when hospitalisation not required for positive, asymptomatic cases
```

Case load is an important metric that is correlated also with hospital load. Here, it's the sum of people who are not recovered. 

```{r}
df_cases_day$date = as.Date(df_cases_day$date)
df_cases_day$case_load = df_cases_day$I1 + df_cases_day$I2 + df_cases_day$I3
df_cases_day$hospital_load = df_cases_day$case_load
df_cases_day[date>=date_no_hosp,]$hospital_load =  
  df_cases_day[date>=date_no_hosp,]$hospital_load * hosp_prop
```
 
```{r}
renderPlot({
  ggplot(data=df_cases_day, aes(x=date, y=case_load)) +
    geom_line(color="steelblue", size=1) + 
    geom_point(color="steelblue", size=2) + 
    xlab("") + ylab("Number of recovering cases\n") + 
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    theme +
    theme(axis.text.x=element_text(angle = 90))
})
```

#### Back-of-the-envelope hospital load

Measuring hospital load is key to ensure that hospitals are not overloaded.  We assume that the number of those who require hospitalisation is 20% of the case load, since it is a conservative estimate that 20% of the patients require hospitalisation and/or ICU care. 

From [24 Mar 2020](https://go.gov.sg/measures24mar), those who still test positive but display no symptoms will no longer be hospitalised but moved to isolation facilities.

```{r}
renderPlot({
  sec_axis_name = "% of (estimated) maximum patient load\n"
  ggplot(data=df_cases_day, aes(x=date, y=hospital_load)) +
    geom_line(color="steelblue", size=1) + 
    geom_point(color="steelblue", size=2) + 
    geom_vline(xintercept=date_no_hosp, size=1, col=cbp1[2], linetype="dotted") +
    xlab("") + ylab("Number of (estimated) hospitalised persons\n") + 
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    scale_y_continuous(sec.axis = sec_axis(~ ./max_load*100, name=sec_axis_name)) + 
    theme +
    theme(axis.text.x=element_text(angle = 90))
})
```

There are 9 public acute hospitals in Singapore, with an average capacity of 1,200 beds. They are currently operating at approximately [75% load](https://www.moh.gov.sg/resources-statistics/healthcare-institution-statistics/beds-occupancy-rate-(bor)). There is also the NCID has approximately 300 beds. If it is assumed that hospitals can operate at a 90% bed load, to ensure that hospitals are not overtaxed and there is sufficient isolation between covid patients (more than usual required), then there would be `r max_load` beds available. 

#### Hospital/isolation facilities

Most cases are currently in the newly-opened NCID to deal with infectious diseases. It was operational [since 7 Sep 2019](https://www.ncid.sg/News-Events/News/Pages/NCID-Official-Opening.aspx).

```{r}
hospital = df[!tolower(hospital) %in% c("unknown", "not admitted"), list(cases=.N) , by=hospital]
hospital = hospital[order(-cases)]
hospital$proportion = paste0(round(hospital$cases / sum(hospital$cases)*100), "%")
names(hospital) = unlist(lapply(names(hospital), function(word) camelcase_labeller("", word)))
knitr::kable(hospital, "markdown")

no_hospital_data = dim(df[tolower(hospital) %in% c("unknown", "not admitted")])[1]
```

Note: cases whose hospitals were pending at time of press release and those who are not admitted are omitted from table above. There were `r no_hospital_data` (of `r dim(df)[1]`) such cases.


### Recovery

Recovered date is based on the discharged date when there are [consecutive negative PCR tests](https://www.channelnewsasia.com/news/singapore/).

#### Duration of recovery

```{r}
is.recovered = table(!is.na(df$days.to.recover.resources))
median_recovery_time = as.numeric(median(df$days.to.recover.resources, na.rm=T))
mean_recovery_time = round(as.numeric(mean(df$days.to.recover.resources, na.rm=T)), 1)
```
- Number of recovered persons: 
  `r is.recovered[2]`
- Proportion of recovered persons: 
  `r round(prop.table(is.recovered)[2]*100, 1)`%

- Median time to recovery (from confirmed): 
  `r median_recovery_time` days
- Mean time to recovery (from confirmed): 
  `r mean_recovery_time` days

```{r}
binwidth = 5
min = as.numeric(min(df$days.to.recover.resources, na.rm=T))
max = as.numeric(max(df$days.to.recover.resources, na.rm=T))
hist_max = max(table(cut(as.numeric(df$days.to.recover.resources), 
                         breaks=seq(min, max, by=binwidth), right = FALSE)))

ggplot(df, aes(x=days.to.recover.resources)) + 
  geom_histogram(binwidth=binwidth, na.rm=T, color=cbp1[3], fill=cbp1[6], pad=T) + 
  xlab("\nDays to recover") + ylab("Number of people\n") +
  geom_vline(xintercept=mean_recovery_time, size=1, col=cbp1[2], linetype="dotted") +
  scale_y_continuous(breaks=seq(0, hist_max, ifelse(hist_max<30, 1, 5))) +
  scale_x_continuous(breaks=seq(0, max, ifelse(max<30, 1, 5))) + 
  theme
```

#### Risk factors

Is there an association between the risk factors and number of days for recovery?

```{r}
selectInput("age_width", label="Age bin width", choices=c(5, 10, 20), selected=20)
renderPlot({
  # input = list(age_width=10)
  agewidth = as.numeric(input$age_width)
  min = as.numeric(min(df$age, na.rm=T))
  max = as.numeric(max(df$age, na.rm=T))
  data = data.frame(cat=cut(as.numeric(df$age), breaks=seq(0, max, by=agewidth), right = FALSE),
                    age=df$age, days=df$days.to.recover.resources)
  data = data[!is.na(data$cat),]

  gs = list(
    ggplot(data, aes(x=cat, y=days)) + 
      geom_jitter(height = 0, width = 0.1, color=cbp1[3]) +
      geom_boxplot(color=cbp1[6], fill=NA) +
      xlab("Age category") + ylab("Days to recover\n") + theme +
      ggtitle("Age"),
  
    ggplot(df[gender != "unknown"], aes(x=gender, y=days.to.recover.resources)) +
      geom_boxplot(color=cbp1[6], fill=NA) +
      geom_jitter(height = 0, width = 0.1, color=cbp1[3]) +
      xlab("Gender") + ylab("") + theme +
      ggtitle("Gender")
  )

  layout=rbind(c(1, 1, 1, 2))
  grid.arrange(grobs=gs, layout_matrix=layout)
})
```


### Deaths

```{r}
cols = c("age", "gender", "patient.nationality", "patient.citizen", "infection.source",
         "confirmed.at.date", "deceased.at.date")
deceased = df[df$patient.status == "Deceased", ..cols]
deceased$duration = as.numeric(deceased$deceased.at.date - deceased$confirmed.at.date+1)
deceased$patient.citizen = unlist(lapply(deceased$patient.citizen, function(word) {
  if(nchar(word) ==2) toupper(word) else camelcase_labeller("", word)
}))
```

Number of deceased: `r dim(deceased)[1]`

[Fatalities are higher for elderly above 65](https://www.businessinsider.sg/most-us-coronavirus-deaths-ages-65-older-cdc-report-2020-3). 
```{r}
cols = c("age", "gender", "patient.nationality", "patient.citizen", "infection.source",
         "confirmed.at.date", "deceased.at.date", "duration")
show_deceased = deceased[, ..cols]
show_deceased$confirmed.at.date = format(show_deceased$confirmed.at.date, "%d.%m.%y")
show_deceased$deceased.at.date = format(show_deceased$deceased.at.date, "%d.%m.%y")
names(show_deceased) = unlist(lapply(gsub("\\.", " ", names(show_deceased)), function(x) camelcase_labeller("", x)))
knitr::kable(show_deceased, "markdown")
```


### Clusters

#### Top 10 largest clusters

```{r}
cluster_cases = df[cluster != "", c("case", "cluster", "confirmed.at.date", "age")]
cluster_cases$cluster = strsplit(cluster_cases$cluster, "; ")
cluster_cases = data.table(unnest(cluster_cases, cols="cluster"))
clusters = cluster_cases[, list(cases=.N,
                                min.date=min(confirmed.at.date),
                                max.date=max(confirmed.at.date)), by=cluster][order(-cases)]
clusters$duration = as.numeric(clusters$max.date - clusters$min.date + 1)
clusters$proportion = paste0(round(clusters$cases / dim(df)[1]*100), "%")
clusters$no = 1:dim(clusters)[1]
clusters$cluster.short = unlist(lapply(clusters$cluster, function(word) {
  word <- strsplit(word, " ")
  sapply(word, function(x){toupper(paste(substring(x, 1, 1), collapse = ""))
  })
}))
clusters$cluster.short.no = paste0(clusters$cluster.short, " [", clusters$no, "]")
clusters = clusters[, c("no", "cluster", "cases", "proportion",  
                        "min.date", "max.date", "duration", "cluster.short", 
                        "cluster.short.no")]
clusters = merge(clusters, lp_clust, by.x="cluster", by.y="cluster", all.x=T, all.y=F)
```

```{r fig.width=10, fig.height=3}
cluster_cases = merge(cluster_cases, clusters[, c("cluster", "no", "cluster.short.no")], 
                      by.x="cluster", by.y="cluster", all.x=T, all.y=F)
ggplot(cluster_cases[no %in% 1:10], aes(x=reorder(cluster.short.no, -no))) +
  geom_dotplot(method="histodot", binwidth=.1, stackratio=.7, 
               binpositions="all", fill=cbp1[3], stroke=NA) + theme +
  scale_y_continuous(limits=c(0, 3000), breaks=NULL, name=NULL) +
  theme(axis.text.x=element_text(angle = 90, hjust=0.95, vjust=0.2)) + xlab("") + 
  coord_flip()
```

```{r}
show_clusters = clusters[, c("no", "cluster", "type", "cases", "proportion", 
                             "min.date", "max.date", "duration")][order(no)][1:10]
show_clusters$min.date = format(show_clusters$min.date, "%d.%m.%y")
show_clusters$max.date = format(show_clusters$max.date, "%d.%m.%y")
names(show_clusters) = unlist(lapply(gsub("\\.", " ", names(show_clusters)), 
                              function(x) camelcase_labeller("", x)))
knitr::kable(show_clusters, "markdown")
```

```{r}
cluster_cases$no.bract = factor(paste0("[", cluster_cases$no, "]"), 
                                levels=paste0("[", sort(as.integer(unique(cluster_cases$no))), "]"))
ggplot(cluster_cases[no %in% 1:10], aes(x=age)) +
  geom_histogram(binwidth=10) + theme +
  facet_wrap(~no.bract, ncol=3, scales="free_y") + 
  scale_y_continuous(breaks=breaks_f) +
  scale_x_continuous(breaks=breaks_f) +
  theme(strip.background = element_rect(fill=cbp1[3]), 
        axis.text.x=element_text(size=rel(.8)),
        axis.text.y=element_text(size=rel(.8)))+
  ylab("Number of people\n") + xlab("\nAge") + ggtitle("Age profile of top 10 largest clusters")
# TODO if time: https://stackoverflow.com/questions/19440069/ [different colours for type]
```

```{r}
types = unique(clusters$type)
clusters$type = factor(clusters$type, 
                       levels=c("construction", "dormitory",
                                "events", "food",  "shopping", "recreation",
                                "residential", "nursing home",
                                "work", "school", "religious"))
pal = colorFactor(c("#8f5717", "#d48224", # construction, dorm
                    "#25b5db", "#1484c9", # events, food
                    "#863eab", "#3063ba", # nursing home, recreation
                    "#e6da09", "#b081d4", # religious, residential
                    "#1aad0c", "#59cce3", "#8ded8c" # school, shoppping, work
                    ), domain=types)
leaflet(clusters[!(is.na(x) | is.na(y))]) %>% addProviderTiles(providers$Stamen.Toner) %>%
 addCircleMarkers(lat=~y, lng=~x, radius=~5+(cases/10), stroke=FALSE, fillOpacity=0.7,
                  label=~paste0(cluster, " - cases: ", cases, " (", type, ")"), color=~pal(type)) %>%
 addLegend("topright", pal=pal, values=~type, opacity = 1, title = "Cluster type") %>%
 setView(103.812804, 1.360250, zoom=11)
```
Note: some clusters had more than one locality on the map but were only assigned to one point on the map.


## Methods

### Data aquisition

**Prior to 2 Apr 2020**, data was obtained from `r url1` up till 1 Apr 2020. The site became defunct from 2 Apr 2020 onwards though later it was found that they migrated to `r url2`. 

**From 2 Apr 2020**, data was collected based on the [MOH press releases annexes](https://www.moh.gov.sg/news-highlights). 

In addition, the following was done to the dataset collected from `r url1`:

1. Prior data was augmented from this [Straits Times news article](https://www.straitstimes.com/singapore/health/novel-coronavirus-cases-in-singapore) retrospectively with information on clusters and links which were omitted from `r url1`.
2. The MOH annex format was adopted, as it was more comprehensive (more variables) wher certain fields, e.g. links, cluster and hospital were missing prior to that. 
3. The citizenship column was changed to country names. 
4. Columns which were already captured in other columns (from `r url1`) were removed because they could result in conflicting columns.
5. Add a `deceased.at.date` column.

There are some differences between the dataset from `r url1` as compared to the MOH annexes:

1. Does not have hospital information.
2. Does not have cluster information or links (for non-cluster cases).
3. One imported country which is derived from the travel history field in the MOH annex. Where there are multiple countries, it is labelled as "unclear origin". 
4. Long term pass and work pass status seem to be inaccurately captured.

The specific steps taken to get the data: 

1. Adding to daily summary statistics, captured in `cases.csv`.
2. Adding to the case-level dataset, captured in `9999-01-01-data.csv`.
    a. Adding MOH annexes data to the main list of documents. 
    b. Adding `recovered.at.date` if cases have recovered.
    c. Adding new links and clusters to existing cases as contact tracing has made progress.

### Notes about data

1. `symptomatic` < `confirmed` < `recovered` dates.
2. `days.to.recover.symptomatic` = recovered - symptomatic.
3. `days.to.recover.resources` = recovered - confirmed.
4. `hospital` is the hospital warded (may have been transferred from another hospital).
5. `links.to` are linked cases which are not family; `links.to.family` are linked cases which are family.
6. No detailed annexes from 5-6 Apr 2020, only cluster links and release dates updated.
7. The `confirmed.at.date` is press release date, not the `confirmed at date` provided by MOH Annex for dataset collected from 2 Apr 2020, whereas it was otherwise so prior to 2 Apr 2020.

### Session information

```{r}
getS3method("print","sessionInfo")(sessionInfo()[-8])
```

---
This document was created by Eunice J.Y. Soh ([eunices.github.io](https://eunices.github.io)). 

Thanks to Ong Xin Rui and DN for feedback.