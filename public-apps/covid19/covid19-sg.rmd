---
runtime: shiny
title: "Covid-19 in Singapore"
output: 
  html_document:
    toc: true
    theme: flatly
---

This document is best viewed on a computer and is not optimised for mobile viewing.

**DISCLAIMER: Not an epidemiologist, so the information below should not be used for policy. Neither has this document gone through peer review, so please do not cite it.**





```{r echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r}
# Libraries
# library(rvest)
library(knitr)
library(ggplot2)
library(tidyr)
library(plyr)
library(data.table)
library(gridExtra)
library(ggrepel)
library(ggwordcloud)
library(leaflet)
library(kableExtra)
source('main.r')
source('util.r')

# Params
theme = theme_bw()
url1 = "https://co.vid19.sg/cases/search"
url2 = "https://www.againstcovid19.com/singapore/cases/search"
cbp1 = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
# df = try({get_data(url1)})
# if(!grepl("error", df[[1]])) {
#   df = clean_data(df)
# } else {
#   df = get_alternative_data()
# }  
```

```{r include=F}
df = get_alternative_data()
df_cases_day = get_df_cases_day()
events = get_events()
lp_clust = get_clusters()
```

```{r}
# Columns are deaths [D], critical condition (ICU) [I1], cases in hospital [I2], 
# cases well but still test positive [I3], recovered [R],
# new cases (imported) [nI], new cases (local) [nL], total cases [total]:
# see cases.csv
```

## What are the figures

### New cases

#### New cases through time
```{r}
min_date = min(df$confirmed.at.date, na.rm=T)
max_date = max(df$confirmed.at.date, na.rm=T)
date_second_wave = as.Date("2020-02-25")
```

The first case of Covid-19 was detected in Singapore on `r format(min_date, "%d %B %Y")`. 

Key measures and events are marked below. Just at a glance, the border control measures and events (category 4) seem to be effacious as the number of imported cases dropped 31 Mar onwards.

```{r}
summ = df[,list(N=.N),by=c("confirmed.at.date", "infection.type")]

labels = events[]
labels$xend = labels$date
labels$yend = summ[confirmed.at.date %in% labels$xend, list(sum=sum(N)), by="confirmed.at.date"]$sum
labels$x = labels$xend - 5
labels$y = labels$yend + sample(2:6, size=length(labels$yend), replace=T)*50
labels$infection.type = "Local unlinked"

renderPlot({

  data = df[,list(N=.N),by=c("confirmed.at.date", "infection.type")]
  data = merge(data, df[,list(R=-.N),by=c("recovered.at.date")], 
               by.x="confirmed.at.date", by.y="recovered.at.date", all.x=T, all.y=T)
  data = merge(data, df[,list(D=-.N),by=c("deceased.at.date")], 
               by.x="confirmed.at.date", by.y="deceased.at.date", all.x=T, all.y=T)
  data = merge(data, labels, by.x=c("confirmed.at.date", "infection.type"), 
               by.y=c("date", "infection.type"), all.x=T, all.y=T)

  ggplot(data=data[confirmed.at.date >= min_date & confirmed.at.date <= max_date], 
               aes(x=confirmed.at.date, y=N, fill=infection.type, label=no)) +
    geom_bar(position='stack', stat="identity") + 
    geom_bar(aes(x=confirmed.at.date, y=R, fill=cbp1[7]), position='stack', stat="identity") + 
    geom_bar(aes(x=confirmed.at.date, y=D, fill="#525252"), position='stack', stat="identity") + 
    xlab("") + ylab("Number of new cases detected\n") +
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    scale_y_continuous(breaks=breaks_f) +
    scale_fill_manual(name="", 
                      labels=c("Deceased", "Recovered", "Event", "Event/measure",
                               "Imported case", "Local linked", "Local unlinked",
                               "Measure", "Unknown"),
                      values=c("darkgreen", cbp1[4], "white", "grey90",
                               cbp1[c(6, 3)], "#8ccff5", 
                               "grey80", "navyblue"),
                      aesthetics = c("fill", "segment.color")) + 
    theme +
    theme(legend.position="bottom", legend.box = "horizontal", 
          axis.text.x=element_text(angle = 90)) +
    geom_label_repel(nudge_y=100, direction="x", angle=90, vjust=0, force=2, 
                     fontface='bold', color="black", size=3, 
                     segment.size=0.5, segment.color='black', 
                     box.padding = unit(0.4, 'lines'), aes(fill=type),
                     arrow = arrow(length = unit(1, "mm")),
                     point.padding = 0, max.iter=3000, show.legend=F) +
    scale_color_discrete() + 
    geom_vline(xintercept=date_second_wave, size=.5, col=cbp1[2], linetype="dotted")

})
```

```{r}
show_events = events[grepl("event", type)][,c("no", "date", "short")]
show_events$no = paste0("[",show_events$no,"]")
names(show_events) = c("No", "Date", "Event")

show_measures = events[grepl("measure", type)]
show_measures = data.table(unnest(show_measures, related=strsplit(related, ",")))
show_measures$related = as.numeric(show_measures$related)
show_measures$event = paste0("[", show_measures$no, "] ", show_measures$short, " (", 
                             format(show_measures$date, "%d %b"), ")")
show_measures =  show_measures[, list(Measures=paste0(event, collapse = ", ")), by="related"][
  order(as.numeric(related))]
names(show_measures) = c("Category", "Measures")
show_measures[,1] = c(
  "Quarantine and isolation events/measures", 
  "Border control events/measures - to decrease imported cases.",  
  "Social distancing measures - to reduce number of contacts per day.",  
  "Good hygiene measures - to reduce transmission probability of virus.")

show_events %>%
  kable("html", align='clc', caption='Events') %>%
    kable_styling(full_width = F, position = "float_left")
 
show_measures %>%
  kable("html", align='clc', caption='Measures') %>%
    kable_styling(full_width=F, position = "right")
```

From 7 Apr onwards, there was a greater number of unlinked cases.

#### Clusters through time

```{r}
style = "display: inline-block;vertical-align:top;padding-right: 20px"
bootstrapPage(
  div(style=style, dateRangeInput("range_date", "Date range", 
                                   start = min_date, end = max_date, 
                                   min = min_date, max = max_date)))
renderPlot({
  min_date = input$range_date[1]
  max_date = input$range_date[2]
  data = df[df$confirmed.at.date >= min_date & df$confirmed.at.date <= max_date,]
  data = data[data$infection.source == "Local transmission",]
  data$clustered = ifelse(data$cluster == "", "Not in cluster", "Cluster case")
  cluster = data[data$clustered=="Cluster case",]
  cluster = data[!duplicated(data$cluster),]

  ggplot(data=cluster, aes(x=confirmed.at.date)) +
    geom_histogram(stat="bin", binwidth=1, fill=cbp1[1]) + 
    xlab("") + ylab("Number of clusters\n") +
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    theme + theme(axis.text.x=element_text(angle = 90))
})
```

#### Two waves

There were two waves of imported cases, the first from EW 03 to EW 07 and second from EW 08 onwards. These are associated with the Chinese cases mainly and when there was a global spread subsequently with Europe and other countries as the epicenter.

```{r fig.height=12, fig.width=9}
data_1st_wave = df[df$confirmed.at.date < date_second_wave & df$infection.source == "Imported case",]
data_1st_wave = data.table(data_1st_wave)
data_1st_wave = data_1st_wave[, list(N=length(case)), by="country.of.origin"]

data_2nd_wave = df[df$confirmed.at.date >= date_second_wave & df$infection.source == "Imported case",]
data_2nd_wave = data.table(data_2nd_wave)
data_2nd_wave = data_2nd_wave[, list(N=length(case)), by="country.of.origin"]
data_2nd_wave = data_2nd_wave[country.of.origin != "Unclear origin"]

layout = rbind(c(1, 1, 1),
               c(2, 2, 3),
               c(2, 2, 3))

gs = list(ggplot(data_1st_wave, aes(x=reorder(camelcase_labeller("", country.of.origin), -N), y=N)) +
    geom_bar(stat = "identity", fill=cbp1[6]) + coord_flip() + theme_minimal() +
    xlab("") + ylab("") + ggtitle("First wave") +
    theme(axis.text.x=element_text(size=rel(1), angle=90)),

  ggplot(data_2nd_wave, 
        aes(x=reorder(camelcase_labeller("", country.of.origin), -N), y=N, label=N)) +
    geom_bar(stat = "identity", fill=cbp1[3]) + 
    coord_flip() + theme +
    xlab("") + ylab("\nNumber of imported cases detected") + ggtitle("Second wave") +
    theme(axis.text.y=element_text(size=rel(1))) +
    guides(fill=F) +
    scale_y_continuous(breaks=seq(0, max(data_2nd_wave$N, na.rm=T)+20, 20), 
                       limits=c(0, max(data_2nd_wave$N, na.rm=T)+20)) +
    geom_text(aes(fill=country.of.origin, y=N+3), colour = "black", 
              fontface = "bold", size=3, show.legend = FALSE, hjust = 0),

  ggplot(data_2nd_wave, aes(label = country.of.origin, size = N, angle=90)) +
    geom_text_wordcloud_area(eccentricity=.35,
                             color=rep_len(cbp1[c(6, 3, 1)], nrow(data_2nd_wave)),
                             shape="pentagon") + theme_minimal() +
    scale_size_area(max_size = 20) 
)

grid.arrange(grobs=gs, layout_matrix=layout)

```

### Case load

```{r} 
max_load = (9*1200*0.15) + 300       # hospital capacity
hosp_prop = 0.5                      # proportion of cases requiring hospitalisation
date_no_hosp = as.Date("2020-03-24") # date when hospitalisation not required for positive, asymptomatic cases
date_bvh = as.Date("2020-03-24")     # date of opening of bvh
```

```{r}
df_cases_day$icu_rate = (df_cases_day$I1)/ df_cases_day$case_load * 100
df_cases_day$hospitalisation_rate = (df_cases_day$I2 + df_cases_day$I1)/ df_cases_day$case_load * 100
df_cases_day$comm_rate = (df_cases_day$I3)/ df_cases_day$case_load * 100
df_cases_day$max_load = ifelse(df_cases_day$date < date_bvh, max_load, max_load+200)
df_cases_day$percent_load = (df_cases_day$I2+df_cases_day$I1)/df_cases_day$max_load * 100

mean_icu_rate = mean(df_cases_day[date>=date_no_hosp]$icu_rate, na.rm=T)
mean_hospitalisation_rate = mean(df_cases_day[date>=date_no_hosp]$hospitalisation_rate, na.rm=T)
mean_comm_rate = mean(df_cases_day[date>=date_no_hosp]$comm_rate, na.rm=T)
```

Case load is an important metric that is correlated also with hospital load. These are split into those that are in ICU, those that are hospitalised and those which test positive but have no symptoms and are in isolation facilities.
 
```{r}
style = "display: inline-block;vertical-align:top;padding-right: 20px"
bootstrapPage(
  div(style=style, dateRangeInput("range_date_case", "Date range", 
                                   start = min_date, end = max_date, 
                                   min = min_date, max = max_date)))
icu_scale=5
renderPlot({
  ggplot(data=df_cases_day[date<=input$range_date_case[2] & date>=input$range_date_case[1]], 
         aes(x=date, y=case_load)) +
    geom_ribbon(aes(ymin=0, ymax=case_load), fill="#8cd6ff", alpha=.5) + 
    geom_line(color=cbp1[3], size=.5) + 
    geom_point(color=cbp1[3], size=1) + 
    geom_ribbon(aes(ymin=0, ymax=I2), fill="#75ccd1", alpha=.5) + 
    geom_line(aes(y=I2), color="#35c4cc", size=.5) + 
    geom_point(aes(y=I2), color="#35c4cc", size=1) + 
    geom_ribbon(aes(ymin=0, ymax=I1*icu_scale), fill="#3296cf", alpha=.5) + 
    geom_line(aes(x=date, y=I1*icu_scale), color=cbp1[6], size=.5) +
    geom_point(aes(x=date, y=I1*icu_scale), color=cbp1[6], size=1) + 
    xlab("") + ylab("Number of active cases [all] (light blue)\n& hospital cases [ICU + hospitalised] (turquoise)\n") + 
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    scale_y_continuous(sec.axis = sec_axis(~ ./icu_scale, name="Number of active ICU cases (dark blue)\n")) +
    theme +
    theme(axis.text.x=element_text(angle = 90))
})
```

- Mean percentage of cases in ICU (from `r format(date_no_hosp, "%d %b %Y")`): `r  round(mean_icu_rate, 1)`%
- Mean percentage of cases in hospital care [ICU + hospitalised] (from `r format(date_no_hosp, "%d %b %Y")`): `r  round(mean_hospitalisation_rate, 1)`%
- Mean percentage of cases in community isolation facilities (from `r format(date_no_hosp, "%d %b %Y")`): `r  round(mean_comm_rate, 1)`%

```{r}
renderPlot({
  ggplot(data=df_cases_day[date<=input$range_date_case[2] & date>=input$range_date_case[1]],
         aes(x=date, y=comm_rate)) +
    geom_ribbon(aes(ymin=0, ymax=hospitalisation_rate), fill="#75ccd1", alpha=.5) + 
    geom_line(aes(y=hospitalisation_rate), color="#35c4cc", size=.5) + 
    geom_point(aes(y=hospitalisation_rate), color="#35c4cc", size=1) + 
    geom_ribbon(aes(ymin=0, ymax=comm_rate), fill="#8cd6ff", alpha=.5) + 
    geom_line(color=cbp1[3], size=.5) + 
    geom_point(color=cbp1[3], size=1) + 
    geom_ribbon(aes(ymin=0, ymax=icu_rate*icu_scale), fill="#3296cf", alpha=.5) + 
    geom_line(aes(x=date, y=icu_rate*icu_scale), color=cbp1[6], size=.5) +
    geom_point(aes(x=date, y=icu_rate*icu_scale), color=cbp1[6], size=1) + 
    xlab("") + ylab("% of active cases in CIF (light blue)\n& in hospital [ICU + hospitalised] (turquoise)\n") + 
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    scale_y_continuous(sec.axis = sec_axis(~ ./icu_scale, name="% active cases in ICU  (dark blue)\n")) +
    theme +
    theme(axis.text.x=element_text(angle = 90))
})
```

#### Case fatality rate and deaths 

```{r}
cols = c("age", "gender", "patient.nationality", "patient.citizen", "infection.source",
         "confirmed.at.date", "deceased.at.date")
deceased = df[df$patient.status == "Deceased", ..cols]
deceased$duration = as.numeric(deceased$deceased.at.date - deceased$confirmed.at.date+1)
deceased$patient.citizen = unlist(lapply(deceased$patient.citizen, function(word) {
  if(nchar(word) ==2) toupper(word) else camelcase_labeller("", word)
}))
```

- Number of deceased to date: `r dim(deceased)[1]`

```{r}
cols = c("age", "gender", "patient.nationality", "patient.citizen", "infection.source",
         "confirmed.at.date", "deceased.at.date", "duration")
show_deceased = deceased[, ..cols]
show_deceased$confirmed.at.date = format(show_deceased$confirmed.at.date, "%d.%m.%y")
show_deceased$deceased.at.date = format(show_deceased$deceased.at.date, "%d.%m.%y")
names(show_deceased) = unlist(
  lapply(gsub("\\.", " ", names(show_deceased)), function(x) camelcase_labeller("", x)))

show_deceased %>%
  mutate(`Age`=cell_spec(`Age`, "html", color="white", background=
    ifelse(`Age` < 60, cbp1[7], cbp1[3]))) %>%
  kable("html", escape=F, align="c") %>%
  kable_styling(c("condensed", "responsive"), full_width=F) 
```

Typically, Case Fatality Rate (CFR) will increase when hospitals get overwhelmed. 

```{r}
style = "display: inline-block;vertical-align:top;padding-right: 20px"
bootstrapPage(
  div(style=style, dateRangeInput("range_date_cfr", "Date range", 
                                   start = min_date, end = max_date, 
                                   min = min_date, max = max_date)))
death_scale = 1
renderPlot({
  ggplot(data=df_cases_day[date<=input$range_date_cfr[2] & date>=input$range_date_cfr[1]], aes(x=date, y=cfr)) + 
    geom_ribbon(aes(ymin=0, ymax=D*death_scale), fill="#ffc394", alpha=.5) + 
    geom_line(aes(y=D*death_scale), color="#e08f4f", size=.5) + 
    geom_point(aes(y=D*death_scale), color="#e08f4f", size=1) + 
    geom_ribbon(aes(ymin=0, ymax=cfr), fill="#de8035", alpha=.5) + 
    geom_line(color=cbp1[7], size=.5) + 
    geom_point(color=cbp1[7], size=1) + 
    xlab("") + ylab("Case Fatality Rate (dark orange)\n") + 
    scale_y_continuous(sec.axis=sec_axis(~ ./death_scale, name="Cumulative deaths (light orange)\n",
                                         breaks=breaks_f)) +
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") + theme +
    theme(axis.text.x=element_text(angle = 90))
})
```

In addition, [fatalities are higher for elderly above 65](https://www.businessinsider.sg/most-us-coronavirus-deaths-ages-65-older-cdc-report-2020-3). 

```{r}
min = as.numeric(min(df$age, na.rm=T))
max = as.numeric(max(df$age, na.rm=T))
df_deceased_age = data.table(category=cut(as.numeric(df$age), breaks=seq(0, max, by=10), right = FALSE),
                             age=df$age, status=df$patient.status)
df_deceased_age = df_deceased_age[, list(cases=.N) , by=c("category", "status")]
df_deceased_age = dcast(df_deceased_age, category~status, fun.aggregate=NULL, value.var="cases")
df_deceased_age$category = as.character(df_deceased_age$category)
df_deceased_age = df_deceased_age[!is.na(category), c("category", "Deceased",  "Recovered")]
df_deceased_age$category = as.character(df_deceased_age$category)
df_deceased_age = rbind(df_deceased_age, 
                        data.frame(category="Total", 
                                   Deceased=sum(as.numeric(df_deceased_age$`Deceased`), na.rm=T),
                                   Recovered=sum(as.numeric(df_deceased_age$`Recovered`), na.rm=T)))
df_deceased_age[is.na(df_deceased_age)] = 0
df_deceased_age$cfr = 
  round(df_deceased_age$Deceased / (df_deceased_age$Deceased + df_deceased_age$Recovered)*100, 2)

show_deceased_age = df_deceased_age[, c("category", "Deceased", "Recovered", "cfr")]
names(show_deceased_age)[which(names(show_deceased_age)=="cfr")] = "CFR (%)" 
names(show_deceased_age)[which(names(show_deceased_age)=="category")] = "Age category" 
show_deceased_age %>%
  mutate(`CFR (%)`=cell_spec(`CFR (%)`, "html", color="white", background=ifelse(`CFR (%)`>20, cbp1[7], cbp1[3]))) %>%
  kable("html", escape=F, align="c") %>%
  kable_styling(c("condensed", "responsive"), full_width=F) 
```

#### Back-of-the-envelope hospital load

Measuring hospital load is key to ensure that hospitals are not overloaded. 

There are 9 public acute hospitals in Singapore, with an average capacity of 1,200 beds. Prior to covid-19, they were operating at approximately [75% load](https://www.moh.gov.sg/resources-statistics/healthcare-institution-statistics/beds-occupancy-rate-(bor)). The NCID also provides approximately 300 beds. 

If it is assumed that hospitals can operate at a 90% bed load, to ensure that hospitals are not overtaxed and there is sufficient isolation between Covid-19 patients (more than usual required), then there would be `r max_load` beds available. Note that this is a very rough estimate and that hospitals could possibly expand in capacity where needed (e.g. in the NCID can be expanded to [>500 beds](https://www.ncid.sg/Facilities-Services/Pages/default.aspx)).

From [24 Mar 2020](https://go.gov.sg/measures24mar), those who still test positive but display no symptoms will no longer be hospitalised but moved to isolation facilities. We assume that 50% of patients require hospitalisation (as seen in the earlier graphs). 
From [11 Apr 2020](https://www.straitstimes.com/singapore/health/bright-vision-hospital-transfers-all-patients-to-make-room-for-stable-covid-19), 110 stable (but requiring hospital care) Covid-19 patients were transferred to Bright Vision Hospital which has 200 bed space when fully operational.

```{r}
style = "display: inline-block;vertical-align:top;padding-right: 20px"
bootstrapPage(
  div(style=style, dateRangeInput("range_date_pl", "Date range", 
                                   start = min_date, end = max_date, 
                                   min = min_date, max = max_date)))

renderPlot({
  patient_load_scale = 10
  sec_axis_name = "% of maximum patient load (light blue)\n"
  ggplot(data=df_cases_day[date<=input$range_date_pl[2] & date>=input$range_date_pl[1]], 
         aes(x=date, y=I2)) +
    geom_ribbon(aes(ymin=0, ymax=I2), fill="#3296cf", alpha=.5) + 
    geom_line(color=cbp1[6], size=.5) + 
    geom_point(color=cbp1[6], size=1) + 
    geom_ribbon(aes(ymin=0, ymax=percent_load*patient_load_scale), fill="#8cd6ff", alpha=.5) + 
    geom_line(aes(y=percent_load*patient_load_scale), color=cbp1[3], size=.5) + 
    geom_point(aes(y=percent_load*patient_load_scale), color=cbp1[3], size=1) + 
    geom_vline(xintercept=date_no_hosp, size=1, col=cbp1[2], linetype="dotted") +
    xlab("") + ylab("Number of hospitalised persons (dark blue)\n") + 
    scale_x_date(date_breaks = "week", date_minor_breaks = "1 day", date_labels = "%d-%b") +
    scale_y_continuous(sec.axis = sec_axis(~ ./patient_load_scale, name=sec_axis_name, 
                                           breaks=seq(0, 100, 10))) + 
    theme +
    theme(axis.text.x=element_text(angle = 90))
})
```

#### Hospitals/isolation facilities

Most cases are currently in the newly-opened NCID to deal with infectious diseases. It was operational [since 7 Sep 2019](https://www.ncid.sg/News-Events/News/Pages/NCID-Official-Opening.aspx).

```{r}
hospital = df[!tolower(hospital) %in% c("unknown", "not admitted"), list(cases=.N) , by=hospital]
hospital = hospital[order(-cases)]
hospital$proportion = paste0(round(hospital$cases / sum(hospital$cases)*100), "%")
names(hospital)[which(names(hospital) == "hospital")] = "hospital.or.facility"

no_hospital_data = dim(df[tolower(hospital) %in% c("unknown", "not admitted")])[1]
```

```{r}
show_hospital = hospital[, c("hospital.or.facility", "cases", "proportion")]
names(show_hospital) = unlist(
  lapply(names(show_hospital), function(word) camelcase_labeller("", word)))

show_hospital %>%
  mutate(`Hospital Or Facility`=cell_spec(`Hospital Or Facility`, "html", color="white", 
                              background=ifelse(
                                `Hospital Or Facility` == "Community Isolation Facility", cbp1[2], 
                                ifelse(nchar(`Hospital Or Facility`)>6, cbp1[7], cbp1[3])))) %>%
  kable("html", escape=F) %>%
  kable_styling(c("condensed", "responsive"), full_width=F)
```
Legend: light orange = community isolation facilities (e.g. D'Resort NTUC in Pasir Ris, Singapore Expo), dark orange = private hospitals,  blue = public hospitals

Note: cases whose hospitals were pending at time of press release and those who are not admitted are omitted from table above. There were `r no_hospital_data` (of `r dim(df)[1]`) such cases. 

```{r}
# df_cases_day_hosp = get_df_cases_day_hosp(df)
# melted_df_cases_day_hosp = melt(df_cases_day_hosp, id.vars=c("date", "hospital"), 
#                                 measure.vars=c("I", "R", "D"))

# hosp_cases = df[!(tolower(hospital) %in% c("unknown", "", "not admitted")), 
#                 list(cases=.N), by=c("confirmed.at.date", "hospital")]

# hosp_scale=10

# renderPlot({
#   ggplot(melted_df_cases_day_hosp[!(tolower(hospital) %in% c("unknown", "")) & variable=="I"], aes(x=date, y=value)) +
#     geom_line(show.legend=F, color=cbp1[6], size=1) +
#     geom_bar(data=hosp_cases, aes(x=confirmed.at.date, y=cases*hosp_scale), 
#              stat="identity", fill=cbp1[3], color=NA, alpha=0.6) +
#     facet_wrap(~hospital) +
#     scale_y_continuous(sec.axis = sec_axis(~ ./hosp_scale, name="Number of new cases in hospitals (bars)\n")) +
#     ylab("Number of active cases in hospital (line)\n") + xlab("") + 
#     theme
# })
```

### Recovery

Recovered date is based on the discharged date when there are [consecutive negative PCR tests](https://www.channelnewsasia.com/news/singapore/).

#### Duration of recovery

```{r}
is.recovered = table(!is.na(df$recovered.at.date))
median_recovery_time = as.numeric(median(df$days.to.recover.resources, na.rm=T))
mean_recovery_time = round(as.numeric(mean(df$days.to.recover.resources, na.rm=T)), 1)
```

- Number of recoveries to date: `r is.recovered[2]`
- Proportion of recoveries to date: `r round(prop.table(is.recovered)[2]*100, 1)`%

- Median time to recovery (from confirmed): `r median_recovery_time` days
- Mean time to recovery (from confirmed): `r mean_recovery_time` days

```{r}
binwidth = 5
min = as.numeric(min(df$days.to.recover.resources, na.rm=T))
max = as.numeric(max(df$days.to.recover.resources, na.rm=T))
hist_max = max(table(cut(as.numeric(df$days.to.recover.resources), 
                         breaks=seq(min, max, by=binwidth), right = FALSE)))

ggplot(df, aes(x=days.to.recover.resources)) + 
  geom_histogram(binwidth=binwidth, na.rm=T, color=cbp1[3], fill=cbp1[6], pad=T) + 
  xlab("\nDays to recovery") + ylab("Number of cases\n") +
  geom_vline(xintercept=mean_recovery_time, size=1, col=cbp1[2], linetype="dotted") +
  scale_y_continuous(breaks=seq(0, hist_max, ifelse(hist_max<30, 1, 20))) +
  scale_x_continuous(breaks=seq(0, max, ifelse(max<30, 1, 5))) + 
  theme
```

#### Risk factors

Is there an association between the risk factors and number of days for recovery? Recovery in this case does not refer to clinical symptoms but the detection of viral nucleic acid from [nasal swabs](https://mothership.sg/2020/04/singapore-covid-19-nose-swab/), which may be dead or alive.

```{r}
selectInput("age_width", label="Age bin width", choices=c(5, 10, 20), selected=20)

renderPlot({
  # input = list(age_width=10)
  agewidth = as.numeric(input$age_width)
  min = as.numeric(min(df$age, na.rm=T))
  max = as.numeric(max(df$age, na.rm=T))
  data = data.frame(cat=cut(as.numeric(df$age), breaks=seq(0, max, by=agewidth), right = FALSE),
                    age=df$age, days=df$days.to.recover.resources)
  data = data[!is.na(data$cat),]

  gs = list(
    ggplot(data, aes(x=cat, y=days)) + 
      geom_jitter(height = 0, width = 0.1, color=cbp1[3]) +
      geom_boxplot(color=cbp1[6], fill=NA) +
      xlab("Age category") + ylab("Days to recover\n") + theme +
      ggtitle("Age"),
  
    ggplot(df[gender != "unknown"], aes(x=gender, y=days.to.recover.resources)) +
      geom_boxplot(color=cbp1[6], fill=NA) +
      geom_jitter(height = 0, width = 0.1, color=cbp1[3]) +
      xlab("Gender") + ylab("") + theme +
      ggtitle("Gender")
  )

  layout=rbind(c(1, 1, 1, 2))
  grid.arrange(grobs=gs, layout_matrix=layout)

})
```

### Clusters

#### Top 10 largest clusters

```{r}
cluster_cases = df[cluster != "", c("case", "cluster", "confirmed.at.date", "age", "patient.citizen")]
cluster_cases$cluster = strsplit(cluster_cases$cluster, "; ")
cluster_cases = data.table(unnest(cluster_cases, cols="cluster"))

clusters = cluster_cases[, list(cases=.N,
                                min.date=min(confirmed.at.date),
                                max.date=max(confirmed.at.date)),
                          by=cluster][order(-cases)]
clusters$duration = as.numeric(clusters$max.date - clusters$min.date + 1)
clusters$proportion = paste0(round(clusters$cases / dim(df)[1]*100), "%")
clusters$no = 1:dim(clusters)[1]
clusters$cluster.short = unlist(lapply(clusters$cluster, function(word) {
  word <- strsplit(word, " ")
  sapply(word, function(x){toupper(paste(substring(x, 1, 1), collapse = ""))
  })
}))
clusters$cluster.short.no = paste0(clusters$cluster.short, " [", clusters$no, "]")
clusters = clusters[, c("no", "cluster", "cases", "proportion",  
                        "min.date", "max.date", "duration", "cluster.short", 
                        "cluster.short.no")]
clusters = merge(clusters, lp_clust, by.x="cluster", by.y="cluster", all.x=T, all.y=F)

cluster_cases = merge(cluster_cases, clusters[, c("cluster", "no", "cluster.short.no")], 
                      by.x="cluster", by.y="cluster", all.x=T, all.y=F)
```

```{r fig.width=10, fig.height=2}
# ggplot(cluster_cases[no %in% 1:10], aes(x=reorder(cluster.short.no, -no))) +
#   geom_dotplot(method="histodot", binwidth=.1, stackratio=.7, 
#               binpositions="all", fill=cbp1[3], stroke=NA) + theme +
#   scale_y_continuous(limits=c(0, 100000), breaks=NULL, name=NULL) +
#   theme(axis.text.x=element_text(angle = 90, hjust=0.95, vjust=0.2)) + xlab("") + 
#   coord_flip()
```

```{r}
show_clusters = clusters[, c("no", "cluster", "type", "cases", "proportion", 
                             "min.date", "max.date", "duration")][order(no)][1:10]
show_clusters$min.date = format(show_clusters$min.date, "%d.%m.%y")
show_clusters$max.date = format(show_clusters$max.date, "%d.%m.%y")
names(show_clusters) = unlist(lapply(gsub("\\.", " ", names(show_clusters)), 
                              function(x) camelcase_labeller("", x)))
show_clusters %>% 
  mutate(Cases=cell_spec(Cases, "html", color="white", background=ifelse(Cases>100, cbp1[7], cbp1[3]))) %>%
  kable("html", escape=F) %>%
  kable_styling(c("condensed", "responsive"), full_width=F)
```

```{r}
cluster_cases$no.bract = factor(paste0("[", cluster_cases$no, "]"), 
                                levels=paste0("[", sort(as.integer(unique(cluster_cases$no))), "]"))
renderPlot({
  ggplot(cluster_cases[no %in% 1:10], aes(x=age)) +
    geom_histogram(binwidth=10) + theme +
    facet_wrap(~no.bract, ncol=3, scales="free_y") + 
    theme(axis.text.x=element_text(size=rel(1)),
          axis.text.y=element_text(size=rel(1)))+
    scale_y_continuous(breaks=breaks_f) +
    scale_x_continuous(breaks=breaks_f) +
    ylab("Number of people\n") + xlab("\nAge") + ggtitle("Age profile of top 10 largest clusters")
})
# TODO if time: https://stackoverflow.com/questions/19440069/ [different colours for type]
```

```{r}
renderPlot({
  cluster_cases$patient.citizen = factor(cluster_cases$patient.citizen,
    levels=c("citizen", "pr", "sp", "wp", "lp", "visitor", "unknown"),
    labels=c("Citizen", "PR", "SP", "WP", "LP", "Visitor", "Unknown"))
  ggplot(cluster_cases[no %in% 1:10], aes(x=patient.citizen, fill=patient.citizen)) +
    geom_bar(stat="count") + theme +
    facet_wrap(~no.bract, ncol=3, scales="free_y") + 
    theme(axis.text.x = element_blank(), 
          axis.ticks = element_blank(),
          legend.position="bottom", legend.box = "vertical",
          axis.text.y=element_text(size=rel(1)))+
    scale_y_continuous(breaks=breaks_f) +
    scale_fill_manual(name="", values=cbp1[c(2, 7, 5, 3, 6, 4, 1)]) +
    ylab("Number of people\n") + xlab("\nStatus") + ggtitle("Status of top 10 largest clusters")
})
```

```{r}
types = unique(clusters$type)
clusters$type = factor(clusters$type, 
                       levels=c("construction", "dormitory",
                                "events", "food", "shopping", "recreation",
                                "residential", "nursing home",
                                "work", "school", "religious"))
pal = colorFactor(c("#8f5717", "#d48224", # construction, dorm
                    "#25b5db", "#1484c9", # events, food
                    "#863eab", "#3063ba", # nursing home, recreation
                    "#e6da09", "#b081d4", # religious, residential
                    "#1aad0c", "#59cce3", "#8ded8c" # school, shoppping, work
                    ), domain=types)
renderLeaflet({
 leaflet(clusters[!(is.na(x) | is.na(y))]) %>% addProviderTiles(providers$Stamen.Toner) %>%
 addCircleMarkers(lat=~y, lng=~x, radius=~5+(cases/20), stroke=FALSE, fillOpacity=0.7,
                  label=~paste0(cluster, " - cases: ", cases, " (", type, ")"), color=~pal(type)) %>%
 addLegend("topright", pal=pal, values=~type, opacity = 1, title = "Cluster type") %>%
 setView(103.812804, 1.360250, zoom=11)
})
```
Note: some clusters had more than one locality on the map but were only assigned to one point on the map.


## Methods

### Data aquisition

**Prior to 2 Apr 2020**, data was obtained from `r url1` up till 1 Apr 2020. The site became defunct from 2 Apr 2020 onwards though later it was found that they migrated to `r url2`. 

**From 2 Apr 2020**, data was collected based on the [MOH press releases annexes](https://www.moh.gov.sg/news-highlights). 

In addition, the following was done to the earlier dataset collected from `r url1`:

1. Prior data was augmented from this [Straits Times news article](https://www.straitstimes.com/singapore/health/novel-coronavirus-cases-in-singapore) retrospectively with information on clusters and links which were omitted from `r url1`.
2. The MOH annex format was adopted, as it was more comprehensive (more variables) wher certain fields, e.g. links, cluster and hospital were missing prior to that. 
3. The citizenship column was changed to country names. 
4. Columns which were already captured in other columns (from `r url1`) were removed because they could result in conflicting columns.
5. Add a `deceased.at.date` column.

There are some differences between the earlier dataset from `r url1` as compared to the MOH annexes:

1. Does not have hospital information.
2. Does not have cluster information or links (for non-cluster cases).
3. One imported country which is derived from the travel history field in the MOH annex. Where there are multiple countries, it is labelled as "unclear origin". 
4. Long term pass and work pass status seem to be inaccurately captured.

The specific steps taken for data collection of the later dataset from MOH Annexes: 

1. Adding to daily summary statistics, captured in `cases.csv`.
2. Adding to the case-level dataset, captured in `9999-01-01-data.csv`.
    a. Adding MOH annexes data to the main list of documents. 
    b. Adding `recovered.at.date` if cases have recovered.
    c. Adding new links and clusters to existing cases as contact tracing has made progress.
3. Georeferencing new clusters in `clusters.csv`.
4. Adding new events in `events.csv`.

### Notes about data

1. `symptomatic` < `confirmed` < `recovered` dates.
2. `days.to.recover.symptomatic` = recovered - symptomatic.
3. `days.to.recover.resources` = recovered - confirmed.
4. `hospital` is the hospital warded (may have been transferred from another hospital).
5. `links.to` are linked cases which are not family; `links.to.family` are linked cases which are family.
6. No detailed annexes from 5-6 Apr 2020, only cluster links and release dates updated.
7. The `confirmed.at.date` is press release date, not the `confirmed at date` provided by MOH Annex for dataset collected from 2 Apr 2020, whereas it was otherwise so prior to 2 Apr 2020.

### Session information

```{r}
getS3method("print","sessionInfo")(sessionInfo()[-8])
```

---
This document was created by Eunice J.Y. Soh ([eunices.github.io](https://eunices.github.io)). 

Thanks to Ong Xin Rui and DN for feedback.