
library(data.table)
library(tidyr)

filename = "public-apps/covid19/9999-01-01-data.csv"
d = fread(filename)
ddir = "C:\\Users\\ejysoh\\Desktop\\sg-covid-cases\\"

get_li = function(text) {
  text = trimws(text)
  text = gsub(" and ", ", ", text)
  text = strsplit(text, ", ")[[1]]
  print(paste0("There are ",  length(text), " recovered."))
  text[order(text)]
}

recovered = "113, 126, 180, 261, 309, 325, 358, 393, 408, 463, 523, 524, 553, 585, 609, 654, 679, 699, 721, 772, 788, 789, 793, 836, 868, 920, 932, 951, 955, 1022, 1122 and 1463"
links = "
[1] Acacia Lodge: Cases 898, 1270, 1336, 1495, 1505, 1956, 1626, 1695, 1993, 2003, 2004 and 2286, 2348, 2491 and 2492.

[2] Tuas View Dormitory: Cases 1473, 1539, 1996, 2071, 2242, 2134, 2329 and 2334.

[3] 36 Woodlands Industrial Park E1: Cases 1724, 1725, 1834, 1837, 1838, 1912, 1913, 1987, 1988, 1989, 2005, 2006, 2007, 2048, 2051, 2053, 2073, 2074, 2076 and 2077.

[4] 85 Kallang Dormitory: Cases 1585, 2059, 2062, 2097 and 2172.

[5] Black Tap: Cases 879, 1010, 1235, 1397, 1402, 1561, 1612 and 1618.

[6] Kenyon/ UBS construction site: Cases 1647, 1939, 1940, 1941, 1942, 2280, 2281 and 2291.

[7] McDonaldâ€™s: Cases 1973, 2066, 2096 and 2302.

[8] S11 Dormitory: 826, 829, 852, 860, 946, 947, 966, 979, 982, 993, 1035, 1039, 1047, 1050, 1061, 1066, 1074, 1083, 1084, 1089, 1107, 1108, 1110, 1111, 1112, 1117, 1118, 1119, 1126, 1135, 1138, 1145, 1153, 1155, 1156, 1171, 1173, 1174, 1185, 1186, 1187, 1198, 1213, 1222, 1223, 1224, 1225, 1228, 1232, 1236, 1269, 1275, 1278, 1279, 1280, 1281, 1283, 1284, 1285, 1286, 1287, 1288, 1289, 1290, 1291, 1292, 1293, 1300, 1302, 1304, 1307, 1308, 1310, 1318, 1321,1329, 1334, 1344, 1350, 1351, 1353, 1354, 1355, 1357, 1358, 1363, 1364, 1365, 1372, 1381, 1382, 1439, 1445, 1455, 1462, 1468, 1470, 1471, 1509, 1512, 1523, 1554, 1572, 1573, 1574, 1580, 1584, 1590, 1591, 1594, 1598, 1600, 1601, 1605, 1606, 1614, 1623, 1515, 1545, 1611, 1613, 1619, 1620, 1657, 1658, 1659, 1675, 1676, 1677, 1678, 1679, 1681, 1682, 1685, 1691, 1693, 1701, 1713, 1729, 1734, 1736, 1746, 1748, 1749, 1750, 1752, 1753, 1754, 1755, 1758, 1759, 1760, 1761, 1762, 1763, 1764, 1765, 1766, 1767, 1768, 1769, 1770, 1771, 1772, 1773, 1774, 1775, 1776, 1777, 1778, 1779, 1780, 1781, 1782, 1783, 1784, 1785, 1786, 1787, 1788, 1789, 1790, 1791, 1792, 1793, 1794, 1795, 1796, 1797, 1798, 1799, 1800, 1801, 1802, 1803, 1804, 1805, 1806, 1807, 1808, 1809, 1810, 1811, 1812, 1813, 1814, 1815, 1816, 1817, 1818, 1819, 1820, 1821, 1822, 1823, 1824, 1829, 1846, 1847, 1848, 1849, 1850, 1851, 1852, 1853, 1854, 1855, 1856, 1857, 1858, 1859, 1860, 1861, 1862, 1863, 1864, 1865, 1866, 1867, 1868, 1869, 1870, 1871, 1872, 1873, 1874, 1875, 1876, 1877, 1878, 1879, 1880, 1881, 1882, 1883, 1884, 1885, 1886, 1887, 1888, 1889, 1890, 1891, 1892, 1893, 1894, 1895, 1896, 1897, 1898, 1899, 1900, 1901, 1902, 1903, 1904, 1905, 1906, 1907, 1908, 1909, 1910, 1617, 1922, 1923, 1924, 1925, 1928, 1932, 1933, 1982, 1983, 2001, 2010, 2036, 2037, 2038, 2039, 2040, 2041, 2042, 2043, 2044, 2045, 2046, 2098, 2110, 2117, 2158, 2159, 2161, 2162, 2202, 2203, 2213, 2216, 2236, 2264, 2268, 2270, 2271, 2284, 2294, 2297, 2115, 2119, 2121, 2122, 2123, 2129, 2136, 2138, 2156, 2052, 2102, 2227, 2228, 2229, 2230, 2234, 2243, 2244, 2279,  2295, 2300, 2304, 2305, 2307, 2308, 2309, 2311, 2312, 2313, 2315, 2317, 2318, 2319, 2320, 2321, 2340, 2347,  2358, 2384, 2482 and 2493.

[9] Westlite Toh Guan: 655, 875, 922, 924, 925, 926, 934, 977, 1011, 1012, 1054, 1062, 1068, 1072, 1100, 1101, 1113, 1176, 1194, 1202, 1216, 1218, 1238, 1251, 1252, 1253, 1255, 1256, 1330, 1391, 1400, 1401, 1441, 1466, 1467, 1508, 1511, 1522, 1616, 1621, 1673, 1674, 1680, 1683, 1684, 1730, 1745, 1747, 1756, 1917, 1927, 1945, 1947, 1970, 1976, 1997, 2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032, 2034, 2035, 2063, 2088, 2095, 2226, 2233, 2235, 2269, 2276, 2355 and 2391.

[10] Toh Guan Dormitory: Cases 963, 1079, 1106, 1148, 1150, 1195, 1254, 1273, 1262, 1263, 1271, 1274, 1276, 1347, 1395, 1453, 1469, 1475, 1374, 1434, 1446, 1582, 1599, 1627, 1841, 1916, 1918, 1969, 1978, 1979, 1980, 1981, 1984, 1985, 2108, 2149, 2150, 2153, 2155, 2166, 2126, 2127, 2152, 2337 and 2435.

[11] Sungei Tengah Lodge: Cases 1054, 1077, 1124, 1267, 1306, 1319, 1342, 1362, 1367, 1388, 1396, 1411, 1430, 1438, 1459, 1474, 1476, 1481, 1482, 1492, 1496, 1498, 1502, 1527, 1586, 1587, 1596, 1602, 1603, 1497, 1544, 1550, 1653, 1688, 1699, 1709, 1718, 1719, 1705, 1737, 1826, 1827, 1843, 1551, 1935 1960 1964, 1966, 1994, 1998, 2002, 2015, 2086, 2087, 2094, 1934, 1946, 2050, 2055, 2101, 2104, 2106, 2131, 2109, 2112, 2135, 2137, 2190, 2252, 2255, 2275, 2154, 2167, 2195, 2251, 2253, 2254, 2316, 2327 and 2331.

[12] Tampines Dormitory: Cases 1049, 1140 , 1193, 1226, 1299, 1261, 1313, 1314, 1327, 1373, 1410,1440, 1442, 1454, 1457, 1458, 1479, 1571, 1576, 1581, 1608, 1624, 1625, 1629, 1632, 1633, 1634, 1635, 1637, 1638, 1639, 1641, 1661, 1663, 1667, 1668, 1692, 1694, 1671, 1919, 1920, 1929, 1930, 1931, 1951, 1957, 1971, 1972, 2018, 2116 and 2289.

[13] Kranji Lodge: Cases 880, 1190, 1241, 1506, 1519, 1520, 1630, 2141, 2246, 2247, 2248, 2250 and 2326.

[14] Cochrane Lodge I: Cases 1018, 1144, 1339, 1394, 1406, 1418, 1419, 1437, 1645, 1655, 1722, 1938, 2057, 2065, 2070, 2082, 2090, 2100, 2111, 2120, 2147, 2204, 2164, 2175, 2272, 2274, 2301, 2322, 2324, 2362, 2363 and 2498.

[15] Cochrane Lodge II: Cases 956, 967, 1104, 1240, 1349, 1640, 2093, 2132, 2140, 2249, 2266, 2296, 2323, 2369, 2372, 2500 and 2505.

[16] Shaw Lodge: Cases 1379, 1380, 1556, 1558, 1564, 1728, 1926, 2113, 2191, 2192, 2196, 2197, 2198, 2199, 2237 and 2239.

[17] Cassia @ Penjuru: Cases 1636, 1651 and 1739, 2151, 2170, 2293, 2299, 2310 and 2336.

[18] 31 Sungei Kadut Avenue and 21B Senoko Loop: Cases 1384, 1549, 1568, 1731, 1735, 1830, 1831, 2209, 2277, 2238 and 2245.

[19] Project Glory: Cases 956, 967, 1019, 1078, 1079, 1104, 1120,  1124, 1149, 1162, 1164, 1181, 1191, 1226, 1263, 1271, 1273, 1341, 1346, 1347, 1349, 1421, 1448, 1449, 1485, 1486, 1503, 1514, 1531, 1555, 1575, 1576, 1577, 1629, 1642, 1652, 1692, 1694, 1715, 1840, 1957, 1975, 1992, 2050, 2058 and 2152.

[20] Renovation sites at the National University Hospital: Cases 1146, 1478, 1563, 1665, 1724, 1725, 1834, 1837, 1838, 1912, 1988, 2005, 2006, 2007, 2048, 2051, 2073, 2074, 2076 and 2077.

[21] Mustafa Centre: Cases 616, 788, 828, 866, 876, 908, 911, 912, 914, 938, 964, 1001, 1015, 1024, 1025, 1026, 1046, 1056, 1093, 1096, 1127, 1160, 1169, 1180, 1182, 1188, 1189, 1196, 1199, 1200, 1201, 1206, 1209, 1214, 1219, 1227, 1246, 1259, 1260, 1277, 1282, 1295, 1315, 1316, 1326, 1340, 1343, 1361, 1375, 1385, 1387, 1417, 1422, 1431, 1432, 1433, 1435, 1443, 1444, 1460, 1487, 1489, 1507, 1528, 1569, 1628, 1643, 1664, 1690, 1700, 1708, 1717, 1732, 1742, 1915, 1954, 2023, 2024, 2118, 2341, 2531 and 2532.

[22] The Orange Ballroom: Cases 510, 511, 1007, 1073 and 1115.
"
text = links

# Recovered
recovered = get_li(recovered)
d[case %in% recovered]$recovered.at.date = as.character("2020-04-12")


# Links/ clusters
links = unlist(strsplit(text, "\\n"))
links = data.frame(text=links)
links$text = as.character(links$text)
links = links[links$text != "",]
links = data.frame(text=links)
links$text = as.character(links$text)
links_de = data.frame(do.call('rbind', strsplit(as.character(links$text),': ',fixed=TRUE)))
names(links_de) = c("cluster", "cases")

# Manual 
links_filename = paste0(ddir, "clean.csv")
# write.csv(links_de, links_filename, row.names=F)

links_de = fread(links_filename)
links_de$cases = gsub("Cases |\\.", "", links_de$cases)
links_de$cases = gsub(" and ", ", ", links_de$cases)
links_de$cases = lapply(links_de$cases, function(text) strsplit(text, ", ")[[1]])
links_de = data.table(unnest(links_de, cols=c("cases")))
links_de$cases = as.integer(links_de$cases)
links_de = links_de[!is.na(cases)]
links_de = unique(links_de)

# links_de[duplicated(links_de$cases)]
# i = which(links_de$case == 1104)[1]

for(i in 1:dim(links_de)[1]) {
  idx = as.integer(links_de[i,]$cases)
  clust = as.character(links_de[i,]$cluster)
  if(d[case==idx,]$cluster == "") {
    d[case==idx,]$cluster = clust
  } else if (grepl(clust, d[case==idx,]$cluster)){
    # don't do anything
  } else {
    d[case==idx,]$cluster = paste0(d[case==idx,]$cluster, "; ", clust)
  }
}

write.csv(d, paste0(gsub(".csv", "", filename), "-edit.csv"), row.names=F)

# Manually change -edit to actual